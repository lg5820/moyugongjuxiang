<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç«å…‰æ•™å¸ˆå æ¡£è¡¨æ•´ç†å·¥å…·-å­¦ç§‘å‡ºå“ v11.0</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #10b981; --bg: #f8fafc; --gray-d: #8e9196; --gray-l: #e5e7eb; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }
        body { background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 1600px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; }
        .upload-card { background: #fafafa; border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 12px; transition: 0.2s; }
        .upload-card:hover { border-color: var(--primary); background: #f1f5ff; }
        .controls { margin-top: 20px; display: flex; justify-content: center; gap: 15px; align-items: center; }
        button { padding: 12px 28px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; color: #fff; display: flex; align-items: center; gap: 8px; }
        .btn-p { background: var(--primary); }
        .btn-s { background: var(--success); display: none; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .section-title { margin: 30px 0 15px; padding-left: 12px; border-left: 4px solid var(--primary); font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        
        #effArea { display: flex; overflow-x: auto; gap: 0; border: 1px solid #cbd5e1; background: #cbd5e1; align-items: flex-start; }
        .eff-col { background: #fff; flex: 1; min-width: 180px; display: flex; flex-direction: column; border-right: 1px solid #cbd5e1; }
        .eff-col:last-child { border-right: none; }
        .eff-hd-main { font-weight: bold; font-size: 15px; padding: 10px; border-bottom: 1px solid #333; text-align: center; }
        .eff-hd-sub { display: flex; font-weight: bold; border-bottom: 1px solid #333; background: #f8fafc; }
        .eff-hd-sub div { flex: 1; padding: 6px; border-right: 1px solid #cbd5e1; text-align: center; }
        .eff-hd-sub div:last-child { border-right: none; }
        .eff-row { display: flex; border-bottom: 1px solid #cbd5e1; }
        .eff-row div { flex: 1; padding: 8px 4px; border-right: 1px solid #cbd5e1; text-align: center; display: flex; align-items: center; justify-content: center; min-height: 40px; }
        .eff-row div:last-child { border-right: none; }
        .eff-ft { font-weight: bold; display: flex; border-bottom: 1px solid #cbd5e1; }
        .eff-ft div { flex: 1; padding: 10px 4px; border-right: 1px solid #cbd5e1; text-align: center; }
        
        .table-container { overflow-x: auto; margin-top: 10px; border: 1px solid #cbd5e1; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
        th, td { border: 1px solid #cbd5e1; padding: 10px 6px; vertical-align: middle; line-height: 1.6; }
        .conf { background-color: #fee2e2 !important; color: #dc2626; font-weight: bold; }
        .hd-gray { background: #A6A6A6 !important; color: #fff; font-weight: bold; }
        .cell-gray { background: #D9D9D9 !important; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2 style="font-size: 24px;">ğŸ”¥ ç«å…‰æ•™å¸ˆå æ¡£è¡¨æ•´ç†å·¥å…·-å­¦ç§‘å‡ºå“ <small style="font-size: 14px; color: #64748b;">v11.0 Pro</small></h2>
            <p style="color: #94a3b8; margin-top: 5px;">ç»“æ„ä¼˜åŒ–ç‰ˆ Â· æ ¸å¿ƒå‚æ•°ä¸€é”®é…ç½® Â· ç¨³å®šé«˜æ•ˆè§£æ</p>
        </div>

        <div class="upload-card">
            <input type="file" id="fIn" accept=".xlsx, .xls, .csv" />
            <div class="controls">
                <button class="btn-p" onclick="doParse()">ğŸš€ è§£æå¹¶é¢„è§ˆ</button>
                <button id="btnDl" class="btn-s" onclick="doCombinedExport()">ğŸ“¥ å¯¼å‡ºå…¨é‡ Excel</button>
            </div>
        </div>

        <div class="section-title">ğŸ“Š æ•™å¸ˆæ•ˆèƒ½åˆ†å¸ƒé¢„è§ˆ</div>
        <div id="effArea"></div>

        <div class="section-title">ğŸ“… æ•™å¸ˆå æ¡£æ˜ç»†é¢„è§ˆ</div>
        <div class="table-container" id="previewArea"></div>
    </div>

    <script>
        /**
         * ============================================================
         * æ ¸å¿ƒé…ç½®é¡¹ (å¦‚éœ€ä¿®æ”¹é€»è¾‘ï¼Œè¯·ä¼˜å…ˆåœ¨æ­¤å¤„è°ƒæ•´)
         * ============================================================
         */
        const GLOBAL_CONFIG = {
            // æ•ˆèƒ½è®¡ç®—è§„åˆ™
            efficiency: {
                threshold: 4,      // è¾¾æ ‡ç­çº§æ•°é˜ˆå€¼ï¼šå¤§äºç­‰äºæ­¤æ•°ç®— 1 ä»½æ•ˆèƒ½ï¼Œå¦åˆ™ç®— 0.5 ä»½
                fullScore: 1.0,    // è¾¾æ ‡åçš„æ•ˆèƒ½å€¼
                partialScore: 0.5  // æœªè¾¾æ ‡çš„æ•ˆèƒ½å€¼
            },

            // å¯¼å‡ºæ–‡ä»¶é»˜è®¤è®¾ç½®
            export: {
                fontName: "å¾®è½¯é›…é»‘",
                fileNamePrefix: "ç«å…‰æ•™å¸ˆæ•´ç†æ±‡æ€»"
            },

            // æ ¡åŒºç®€ç§°æ˜ å°„ (ç”¨äºå æ¡£è¡¨å†…å®¹è„±æ•/ç®€åŒ–æ˜¾ç¤º)
            campMap: { 
                "çº¢æ——æ²³æ²Ÿ":"ç†æƒ³", "ç†æƒ³":"ç†æƒ³", "UåŸ":"é¾™æ¹–", "é¾™æ¹–":"é¾™æ¹–", 
                "ç†™è¡—":"ç†™è¡—", "å•†ä¼š":"å•†ä¼š", "è§‚éŸ³æ¡¥":"è§‚éŸ³æ¡¥", "åæ–°è¡—":"åæ–°è¡—", 
                "å—åª":"å—åª", "æ±½åš":"æ±½åš", "æ±‰å›½":"æ±‰å›½", "XY":"é‘«æº", 
                "é‘«æº":"é‘«æº", "QT":"åº†æ³°", "åº†æ³°":"åº†æ³°", "è‰¾ä½³":"è‰¾ä½³", 
                "å—æ¡¥å¯º":"å—æ¡¥å¯º", "å¤§çŸ³å":"å¤§çŸ³å", "èŒ¶å›­":"èŒ¶å›­" 
            },

            // å æ¡£è¡¨ä¸»é¢˜é…è‰² (æ ¹æ®æœŸæ•°/æ˜ŸæœŸæ˜¾ç¤ºä¸åŒé¢œè‰²)
            slotThemes: [
                { keys: ["é›¶æœŸ","å‘¨å››","å‘¨äº”"], head: "FF7C80", body: "FFCCCC" },
                { keys: ["ä¸€æœŸ","å‘¨å…­"], head: "FFD966", body: "FFF2CC" },
                { keys: ["äºŒæœŸ","å‘¨æ—¥"], head: "8EA9DB", body: "DDEBF7" },
                { keys: ["ä¸‰æœŸ"], head: "A9D08E", body: "E2EFDA" }
            ],

            // æ•ˆèƒ½å›¾å¹´çº§é…è‰²æ–¹æ¡ˆ (å¾ªç¯åº”ç”¨)
            effGradeColors: [
                { head: "FFB2B2", body: "FFEBEE" }, // 1å¹´çº§ - æµ…çº¢
                { head: "FFE082", body: "FFF9C4" }, // 2å¹´çº§ - æµ…é»„
                { head: "90CAF9", body: "E3F2FD" }, // 3å¹´çº§ - æµ…è“
                { head: "A5D6A7", body: "E8F5E9" }, // 4å¹´çº§ - æµ…ç»¿
                { head: "CE93D8", body: "F3E5F5" }, // 5å¹´çº§ - æµ…ç´«
                { head: "FFCC80", body: "FFF3E0" }, // 6å¹´çº§ - æµ…æ©™
                { head: "BDBDBD", body: "F5F5F5" }  // å…¶ä»–
            ],

            // ç°è‰²åŸºè°ƒ (ç”¨äºè¡¨ä¾§è¾¹æ )
            grayBase: { dark: "A6A6A6", light: "D9D9D9" }
        };

        // å…¨å±€å˜é‡
        let tableData = [], timeSlots = [], gradeEfficiency = {};

        /**
         * ============================================================
         * åŸºç¡€å·¥å…·å‡½æ•°
         * ============================================================
         */
        const getValue = (row, targetKey) => {
            const actualKey = Object.keys(row).find(k => k.replace(/\s+/g, '').includes(targetKey));
            return actualKey ? String(row[actualKey]).trim() : "";
        };

        const getShortRoom = (str) => (str.replace(/æ•™å®¤|åˆ†æ ¡|æ ¡åŒº/g, "").match(/[A-Z]*\d+/i) || [str])[0];
        
        const getCampName = (str) => {
            const entry = Object.entries(GLOBAL_CONFIG.campMap).find(([key]) => str.includes(key));
            return entry ? entry[1] : str;
        };

        const formatTimePeriod = (timeStr) => {
            const hour = parseInt((timeStr.match(/\d{1,2}/) || [0])[0]);
            if (hour === 0) return "";
            if (hour < 11) return "æ—©";
            if (hour < 14) return "ä¸­";
            if (hour < 18) return "ä¸‹";
            return "æ™š";
        };

        const getSlotStyle = (slotName) => {
            return GLOBAL_CONFIG.slotThemes.find(t => t.keys.some(k => slotName.includes(k))) || { head: "F2F2F2", body: "FFFFFF" };
        };

        const getSortWeight = (slotName) => {
            const weekWeight = {å‘¨ä¸€:10,å‘¨äºŒ:20,å‘¨ä¸‰:30,å‘¨å››:40,å‘¨äº”:50,å‘¨å…­:60,å‘¨æ—¥:70,é›¶æœŸ:100,ä¸€æœŸ:110,äºŒæœŸ:120,ä¸‰æœŸ:130};
            const timeWeight = {æ—©:1,ä¸­:2,ä¸‹:3,æ™š:4};
            const wKey = Object.keys(weekWeight).find(k => slotName.includes(k)) || "";
            return (weekWeight[wKey] || 0) + (timeWeight[slotName.slice(-1)] || 0);
        };

        /**
         * ============================================================
         * æ ¸å¿ƒè§£æä¸æ¸²æŸ“é€»è¾‘
         * ============================================================
         */
        function doParse() {
            const file = document.getElementById('fIn').files[0];
            if (!file) return alert("è¯·å…ˆä¸Šä¼  Excel æ–‡ä»¶");

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames.find(n => n.includes("å¯¼å…¥")) || workbook.SheetNames[0]];
                    const rawData = XLSX.utils.sheet_to_json(sheet);
                    
                    const pivot = {}, gradeMap = {}, uniqueSlots = new Set();
                    const teaGradeSet = {}, gradeTeaCount = {}; 

                    rawData.forEach(row => {
                        const tea = getValue(row, "è®²å¸ˆ") || "æœªçŸ¥";
                        const grade = getValue(row, "å¹´çº§") || "æœªåˆ†ç±»";
                        const type = (getValue(row, "æ—¶é—´ç±»å‹") || getValue(row, "ä¸Šè¯¾æ—¶é—´ç±»å‹")).replace("æ˜ŸæœŸ", "å‘¨");
                        const time = formatTimePeriod(getValue(row, "ä¸‹è¯¾æ—¶é—´") || getValue(row, "æ—¶é—´æ®µ"));
                        
                        if (type.length < 2) return;
                        const slotKey = type + time;
                        uniqueSlots.add(slotKey);

                        // æ±‡æ€»å æ¡£ä¿¡æ¯
                        const classInfo = `${getValue(row, "ç­å‹")}-${getCampName(getValue(row, "æ ¡åŒº"))}-${getShortRoom(getValue(row, "æ•™å®¤"))}-${getValue(row, "æŠ¥åäººæ•°") || 0}`;
                        pivot[tea] = pivot[tea] || {};
                        (pivot[tea][slotKey] = pivot[tea][slotKey] || []).push({ text: classInfo, num: parseInt(getValue(row, "æŠ¥åäººæ•°") || 0) });
                        if (grade) (gradeMap[tea] = gradeMap[tea] || new Set()).add(grade);

                        // æ±‡æ€»æ•ˆèƒ½ç»Ÿè®¡
                        if (!teaGradeSet[tea]) teaGradeSet[tea] = new Set();
                        teaGradeSet[tea].add(grade);
                        if (!gradeTeaCount[grade]) gradeTeaCount[grade] = {};
                        gradeTeaCount[grade][tea] = (gradeTeaCount[grade][tea] || 0) + 1;
                    });

                    // æ’åºæ—¶é—´åˆ—è¡¨
                    timeSlots = [...uniqueSlots].sort((a, b) => getSortWeight(a) - getSortWeight(b));
                    
                    // æ„é€ å æ¡£è¡¨å±•ç¤ºæ•°æ®
                    tableData = Object.keys(pivot).sort().map(tea => {
                        const r = { "è®²å¸ˆ": tea, "å¹´çº§": [...(gradeMap[tea] || [])].join("/"), "æ€»ç­çº§æ•°": 0, "æŠ¥åæ€»äººæ•°": 0 };
                        timeSlots.forEach(s => {
                            const list = pivot[tea][s] || [];
                            r[s] = list.map(item => item.text).join("\n");
                            r[`_conf_${s}`] = list.length > 1; // æ ‡è®°å†²çª
                            r["æ€»ç­çº§æ•°"] += list.length;
                            r["æŠ¥åæ€»äººæ•°"] += list.reduce((sum, item) => sum + item.num, 0);
                        });
                        return r;
                    });

                    // æ„é€ æ•ˆèƒ½è¡¨å±•ç¤ºæ•°æ®
                    gradeEfficiency = {};
                    Object.keys(gradeTeaCount).sort().forEach(g => {
                        gradeEfficiency[g] = Object.entries(gradeTeaCount[g]).map(([name, count]) => ({
                            name: teaGradeSet[name].size > 1 ? name + "*" : name,
                            eff: count >= GLOBAL_CONFIG.efficiency.threshold ? GLOBAL_CONFIG.efficiency.fullScore : GLOBAL_CONFIG.efficiency.partialScore
                        })).sort((a, b) => b.eff - a.eff);
                    });

                    renderPreviews();
                    document.getElementById('btnDl').style.display = "flex";
                } catch (err) { console.error(err); alert("æ•°æ®è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ã€‚"); }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderPreviews() {
            // æ¸²æŸ“æ•ˆèƒ½é¢„è§ˆå›¾
            const effArea = document.getElementById('effArea');
            let effHtml = '';
            Object.keys(gradeEfficiency).forEach((grade, idx) => {
                const color = GLOBAL_CONFIG.effGradeColors[idx] || GLOBAL_CONFIG.effGradeColors[GLOBAL_CONFIG.effGradeColors.length-1];
                let total = 0;
                let rows = gradeEfficiency[grade].map(item => {
                    total += item.eff;
                    return `<div class="eff-row"><div style="background:#${color.body}">${item.name}</div><div style="background:#${color.body}">${item.eff}</div></div>`;
                }).join('');
                effHtml += `
                    <div class="eff-col">
                        <div class="eff-hd-main" style="background:#${color.head}">${grade}</div>
                        <div class="eff-hd-sub"><div>è®²å¸ˆ</div><div>æ•ˆèƒ½</div></div>
                        <div class="eff-body">${rows}</div>
                        <div class="eff-ft" style="background:#${color.head}"><div>æ€»æ•ˆèƒ½</div><div>${total}</div></div>
                    </div>`;
            });
            effArea.innerHTML = effHtml;

            // æ¸²æŸ“å æ¡£æ˜ç»†é¢„è§ˆå›¾
            const previewArea = document.getElementById('previewArea');
            let h = `<table><thead><tr><th class="hd-gray">è®²å¸ˆ</th><th class="hd-gray">å¹´çº§</th>`;
            timeSlots.forEach(s => h += `<th style="background:#${getSlotStyle(s).head}">${s}</th>`);
            h += `<th class="hd-gray">æ€»ç­çº§æ•°</th><th class="hd-gray">æŠ¥åæ€»äººæ•°</th></tr></thead><tbody>`;
            tableData.forEach(r => {
                h += `<tr><td class="cell-gray">${r["è®²å¸ˆ"]}</td><td class="cell-gray">${r["å¹´çº§"]}</td>`;
                timeSlots.forEach(s => h += `<td class="${r[`_conf_${s}`]?'conf':''}" style="background:#${getSlotStyle(s).body}">${r[s]||""}</td>`);
                h += `<td class="cell-gray">${r["æ€»ç­çº§æ•°"]}</td><td class="cell-gray">${r["æŠ¥åæ€»äººæ•°"]}</td></tr>`;
            });
            previewArea.innerHTML = h + `</tbody></table>`;
        }

        /**
         * ============================================================
         * Excel å¯¼å‡ºé€»è¾‘ (åŒ Sheet æ¨¡å¼)
         * ============================================================
         */
        function doCombinedExport() {
            if (!tableData.length) return;
            const wb = XLSX.utils.book_new();
            const font = GLOBAL_CONFIG.export.fontName;
            
            // Sheet 1: æ•™å¸ˆå æ¡£æ˜ç»†
            const headers1 = ["è®²å¸ˆ", "å¹´çº§", ...timeSlots, "æ€»ç­çº§æ•°", "æŠ¥åæ€»äººæ•°"];
            const ws1 = XLSX.utils.aoa_to_sheet([headers1, ...tableData.map(r => headers1.map(h => r[h] || ""))]);
            applyStyleSheet1(ws1, headers1, font);
            XLSX.utils.book_append_sheet(wb, ws1, "æ•™å¸ˆå æ¡£æ˜ç»†");

            // Sheet 2: æ•ˆèƒ½åˆ†å¸ƒè¡¨ (è‡ªé€‚åº”æ±‡æ€»ä½ç½®)
            const grades = Object.keys(gradeEfficiency);
            const maxRows = Math.max(...grades.map(g => gradeEfficiency[g].length)) + 1;
            const aoa2 = [ [], [] ];
            grades.forEach(g => { aoa2[0].push(g, ""); aoa2[1].push("è®²å¸ˆ", "æ•ˆèƒ½"); });
            for (let i = 0; i < maxRows; i++) aoa2.push(new Array(grades.length * 2).fill(""));

            grades.forEach((g, gIdx) => {
                let currentTotal = 0;
                gradeEfficiency[g].forEach((item, tIdx) => {
                    aoa2[tIdx + 2][gIdx * 2] = item.name;
                    aoa2[tIdx + 2][gIdx * 2 + 1] = item.eff;
                    currentTotal += item.eff;
                });
                const summaryIdx = gradeEfficiency[g].length + 2;
                aoa2[summaryIdx][gIdx * 2] = "æ€»æ•ˆèƒ½";
                aoa2[summaryIdx][gIdx * 2 + 1] = currentTotal;
            });

            const ws2 = XLSX.utils.aoa_to_sheet(aoa2);
            applyStyleSheet2(ws2, grades, font);
            XLSX.utils.book_append_sheet(wb, ws2, "å¹´çº§æ•ˆèƒ½åˆ†æ");

            XLSX.writeFile(wb, `${GLOBAL_CONFIG.export.fileNamePrefix}-${getFmtDate()}.xlsx`);
        }

        function applyStyleSheet1(ws, hds, font) {
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; R++) {
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const addr = XLSX.utils.encode_cell({r:R, c:C});
                    if (!ws[addr]) ws[addr] = { t: 's', v: '' };
                    const cell = ws[addr];
                    const isHead = R === 0, isSide = C < 2 || C >= hds.length - 2;
                    const style = getSlotStyle(hds[C] || "");
                    const bg = isHead ? (isSide ? GLOBAL_CONFIG.grayBase.dark : style.head) : (isSide ? GLOBAL_CONFIG.grayBase.light : style.body);
                    
                    cell.s = {
                        font: { name: font, sz: 10, color: { rgb: (isHead && isSide) ? "FFFFFF" : "000000" }, bold: isHead || isSide },
                        alignment: { vertical: "center", horizontal: "center", wrapText: true },
                        fill: { fgColor: { rgb: bg.replace('#', '') } },
                        border: { top: {style: "thin"}, bottom: {style: "thin"}, left: {style: "thin"}, right: {style: "thin"} }
                    };
                }
            }
            ws['!cols'] = [{wch:10}, {wch:12}, ...timeSlots.map(()=>({wch:22})), {wch:10}, {wch:10}];
        }

        function applyStyleSheet2(ws, grades, font) {
            const range = XLSX.utils.decode_range(ws['!ref']);
            ws['!merges'] = grades.map((_, i) => ({ s: { r: 0, c: i * 2 }, e: { r: 0, c: i * 2 + 1 } }));
            
            for (let R = range.s.r; R <= range.e.r; R++) {
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const addr = XLSX.utils.encode_cell({ r: R, c: C });
                    const cell = ws[addr];
                    if (!cell || (cell.v === "" && R > 1)) {
                        if (cell) cell.s = { border: { top: {style: "none"} } }; 
                        continue;
                    }
                    
                    const gIdx = Math.floor(C / 2);
                    const color = GLOBAL_CONFIG.effGradeColors[gIdx] || GLOBAL_CONFIG.effGradeColors[0];
                    let bg = "FFFFFF", bold = false;
                    
                    if (R === 0) { bg = color.head; bold = true; } 
                    else if (R === 1) { bg = "F2F2F2"; bold = true; } 
                    else if (cell.v === "æ€»æ•ˆèƒ½" || (C % 2 === 1 && ws[XLSX.utils.encode_cell({r: R, c: C-1})]?.v === "æ€»æ•ˆèƒ½")) {
                        bg = color.head; bold = true;
                    } else {
                        bg = color.body;
                    }

                    cell.s = {
                        font: { name: font, sz: 10, bold: bold },
                        alignment: { vertical: "center", horizontal: "center" },
                        fill: { fgColor: { rgb: bg.replace('#', '') } },
                        border: { 
                            top: {style: "thin", color: {rgb: "000000"}}, bottom: {style: "thin", color: {rgb: "000000"}}, 
                            left: {style: "thin", color: {rgb: "000000"}}, right: {style: "thin", color: {rgb: "000000"}} 
                        }
                    };
                }
            }
            ws['!cols'] = grades.flatMap(() => [{wch: 15}, {wch: 10}]);
        }

        function getFmtDate() {
            const d = new Date();
            return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
        }
    </script>
</body>
</html>