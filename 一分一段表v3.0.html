<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç»©åˆ†æç³»ç»Ÿ - æ——èˆ°ä¸“ä¸šç‰ˆ</title>
    <!-- ä¾èµ–åº“åŠ è½½ -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- å›¾æ ‡åº“ -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* ============================================================
           é…ç½®åŒºåŸŸï¼šè§†è§‰é…è‰²
           ============================================================ */
        :root {
            /* --- APP UI ä¸»é¢˜è‰² --- */
            --app-bg: #f4f6f9;
            --card-bg: #ffffff;
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --active-tab: #2980b9;
            --shadow-soft: 0 10px 40px rgba(0,0,0,0.06);
            --radius-main: 16px;

            /* --- æŠ¥è¡¨ç”Ÿæˆé…è‰² --- */
            --header-bg: #ffffff;      
            --header-text: #000000;    
            --stat-green:    #C6EFCE;
            --border-dark:   #000000;
            
            /* åˆ†æ•°æ®µé…è‰² */
            --color-90:  #00B050;
            --color-80:  #92D050;
            --color-60:  #00B0F0;
            --color-50:  #FFF2CC;
            --color-low: #FEC200;
        }

        /* åŸºç¡€å¸ƒå±€ */
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background-color: var(--app-bg); padding: 40px 20px; color: #2c3e50; margin: 0; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* å¤´éƒ¨ */
        .app-header { text-align: center; margin-bottom: 30px; }
        .app-header h2 { font-size: 28px; font-weight: 800; margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .app-subtitle { color: #7f8c8d; margin-top: 5px; font-size: 14px; }

        /* --- å¯¼èˆªæ ¸å¿ƒ --- */
        .nav-container { margin-bottom: 25px; }
        
        .level-1-tabs { 
            display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; 
            padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;
        }
        .tab-l1 { 
            padding: 10px 20px; font-size: 16px; font-weight: 700; border: none; background: transparent; 
            color: #95a5a6; cursor: pointer; position: relative; transition: all 0.3s; display: flex; align-items: center; gap: 8px;
        }
        .tab-l1:hover { color: var(--accent-color); }
        .tab-l1.active { color: var(--primary-color); }
        .tab-l1.active::after { 
            content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 3px; 
            background: var(--accent-color); border-radius: 3px 3px 0 0;
        }

        .level-2-container { 
            background: white; padding: 15px 20px; border-radius: 12px; 
            box-shadow: var(--shadow-soft); display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
            min-height: 60px;
        }
        .node-label { font-size: 13px; font-weight: 700; color: #b0b8c1; margin-right: 10px; }
        .tab-l2 { 
            padding: 6px 16px; border-radius: 20px; border: 1px solid #e0e0e0; background: #fff; 
            color: #555; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .tab-l2:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .tab-l2.active { background: var(--accent-color); color: white; border-color: var(--accent-color); box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }

        /* æ§åˆ¶å° */
        .dashboard { background: var(--card-bg); border-radius: var(--radius-main); box-shadow: var(--shadow-soft); padding: 25px; margin-bottom: 30px; }
        
        .controls-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        
        /* æ“ä½œç½‘æ ¼ */
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 25px; padding-top: 25px; border-top: 1px solid #eee; }
        .group-label { font-size: 12px; font-weight: 700; color: #b0b8c1; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; display: block; }

        /* è¾“å…¥ç»„ */
        .input-wrapper { display: flex; gap: 10px; align-items: center; }
        .input-group { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; background: #f8f9fa; padding: 8px 12px; border-radius: 8px; border: 1px solid #e9ecef; }
        .input-group input { width: 40px; border: none; background: transparent; text-align: center; font-weight: 700; color: var(--primary-color); }
        
        /* æŒ‰é’® */
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-danger { background: #fff0f0; color: #e74c3c; border: 1px solid #fadbd8; }
        .btn-apply { background: var(--primary-color); color: white; padding: 8px 12px; border-radius: 6px; border:none; cursor: pointer;}
        .btn-secondary-light { background: #f1f3f5; color: #555; border: 1px solid #e0e0e0; }
        .btn-secondary-light:hover { background: #e9ecef; color: var(--accent-color); border-color: var(--accent-color); }
        
        /* åŠŸèƒ½æŒ‰é’® */
        .btn-download { background: #27ae60; color: white; width: 100%; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2); }
        .btn-download:hover { background: #219150; }
        .btn-secondary { background: #ecf0f1; color: var(--primary-color); width: 100%; }
        .btn-secondary:hover { background: #dfe6e9; }
        .btn-chart { background: #2c3e50; color: white; width: 100%; }

        /* ç»“æœå±•ç¤ºåŒº */
        #result-container { animation: fadeIn 0.5s ease-out; }
        .canvas-card { background: white; padding: 30px; border-radius: var(--radius-main); box-shadow: var(--shadow-soft); margin-bottom: 30px; overflow-x: auto; }
        
        /* --- æŠ¥è¡¨æ ·å¼ --- */
        .main-table { width: 100%; min-width: 800px; border-collapse: collapse; font-size: 13px; color: #000; border: 2px solid var(--border-dark); margin: 0 auto; }
        .main-table th, .main-table td { border: 1px solid var(--border-dark); padding: 7px 4px; text-align: center; }
        
        .row-title { background-color: var(--header-bg); color: var(--header-text); font-size: 18px; font-weight: bold; height: 55px; border-bottom: 2px solid #000; }
        
        .cell-static-green { background-color: var(--stat-green); font-weight: bold; }
        .row-col-header { background-color: #ffffff; font-weight: bold; } 

        /* åŠ¨æ€é…è‰² */
        .bg-90  { background-color: var(--color-90) !important; color: white !important; font-weight: bold; }
        .bg-80  { background-color: var(--color-80) !important; font-weight: bold; }
        .bg-60  { background-color: var(--color-60) !important; font-weight: bold; }
        .bg-50  { background-color: var(--color-50) !important; font-weight: bold; }
        .bg-low { background-color: var(--color-low) !important; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 80px 20px; color: #95a5a6; border: 2px dashed #e0e0e0; border-radius: var(--radius-main); margin-top: 20px; }
        .empty-state i { font-size: 56px; margin-bottom: 20px; display: block; color: #bdc3c7; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; text-align: left; box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .modal-content h3 { margin-top: 0; color: var(--primary-color); font-size: 18px; margin-bottom: 10px; text-align: center; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .guide-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 10px; }
        .guide-table th, .guide-table td { border: 1px solid #ddd; padding: 4px; text-align: center; background: #f9f9f9; }
        .guide-table th { background: #eee; font-weight: bold; }
        .highlight-col { background: #fff3cd !important; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header class="app-header">
        <h2><i class="ph ph-chart-polar" style="color:var(--accent-color)"></i> æˆç»©åˆ†æç³»ç»Ÿ <span style="font-size: 13px; background:#e0f2fe; color:#0284c7; padding:2px 6px; border-radius:4px;">V5.0ï¼ˆéƒ­å“¥æ•‘æˆ‘QAQï¼‰</span></h2>
    </header>

    <div class="dashboard">
        <!-- é¡¶éƒ¨æ“ä½œæ ï¼šæ•°æ®æºä¸é˜ˆå€¼ -->
        <div class="controls-row">
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden" />
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <i class="ph ph-upload-simple"></i> å¯¼å…¥æ•°æ®
                </button>
                <button class="btn btn-secondary-light" onclick="downloadTemplate()">
                    <i class="ph ph-download-simple"></i> ä¸‹è½½æ¨¡æ¿
                </button>
                <button class="btn btn-secondary-light" onclick="showGuide()">
                    <i class="ph ph-question"></i> ä½¿ç”¨ç¤ºä¾‹
                </button>
                <button class="btn btn-danger" style="width: auto;" onclick="confirmClearData()">
                    <i class="ph ph-trash"></i>
                </button>
            </div>

            <div class="input-wrapper hidden" id="thresholdPanel">
                <div class="input-group"><span style="color:var(--color-80)">ä¼˜ç§€</span><input type="number" id="excThreshold" value="85"></div>
                <div class="input-group"><span style="color:var(--color-60)">åŠæ ¼</span><input type="number" id="passThreshold" value="60"></div>
                <button class="btn-apply" onclick="applySettings()"><i class="ph ph-check"></i></button>
            </div>
        </div>

        <!-- åº•éƒ¨æ“ä½œæ ï¼šåŠŸèƒ½ç½‘æ ¼ -->
        <div class="action-grid hidden" id="actionPanel">
            <!-- 1. è§†å›¾åˆ‡æ¢ -->
            <div>
                <span class="group-label">1. è§†å›¾é¢„è§ˆ</span>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="switchViewMode(false)">
                        <i class="ph ph-eye"></i> é¢„è§ˆå®Œæ•´ç‰ˆ
                    </button>
                    <button class="btn btn-secondary" onclick="switchViewMode(true)">
                        <i class="ph ph-eye-slash"></i> é¢„è§ˆéšè—ç‰ˆ
                    </button>
                </div>
            </div>

            <!-- 2. å›¾ç‰‡å¯¼å‡º -->
            <div>
                <span class="group-label">2. å›¾ç‰‡å¯¼å‡º</span>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-download" style="background:var(--accent-color);" onclick="renderAndExport(false)">
                        <i class="ph ph-image"></i> å®Œæ•´ç‰ˆå›¾ç‰‡
                    </button>
                    <button class="btn btn-download" style="background:#8e44ad;" onclick="renderAndExport(true)">
                        <i class="ph ph-image-square"></i> éšè—ç‰ˆå›¾ç‰‡
                    </button>
                </div>
            </div>

            <!-- 3. æ•°æ®å¯¼å‡º -->
            <div>
                <span class="group-label">3. æ•°æ®å¯¼å‡º</span>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-download" onclick="exportToExcel()">
                        <i class="ph ph-file-xls"></i> å¯¼å‡ºExcel
                    </button>
                    <button class="btn btn-chart" onclick="exportChartImg()">
                        <i class="ph ph-chart-bar"></i> å¯¼å‡ºç›´æ–¹å›¾
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¼èˆªåŒºåŸŸ -->
    <div id="navContainer" class="nav-container hidden">
        <!-- ä¸€çº§ï¼šè€ƒè¯•åœºæ¬¡ -->
        <div id="level1Tabs" class="level-1-tabs"></div>
        <!-- äºŒçº§ï¼šç­å‹ -->
        <div id="level2Container" class="level-2-container hidden">
            <span class="node-label"><i class="ph ph-git-branch"></i> ç­å‹é€‰æ‹©:</span>
            <div id="level2Tabs" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
        </div>
    </div>

    <!-- ç»“æœå±•ç¤º -->
    <div id="result-container" class="hidden">
        <div class="canvas-card" id="tableCard"><div id="table-capture-area"></div></div>
        <div class="canvas-card" id="chartCard">
            <div style="max-width: 900px; margin: 0 auto;"><canvas id="scoreChart"></canvas></div>
        </div>
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div id="emptyState" class="empty-state">
        <i class="ph ph-files"></i>
        <h3>å¼€å§‹åˆ†æ</h3>
        <p>è¯·ç‚¹å‡»å·¦ä¸Šè§’â€œå¯¼å…¥æ•°æ®â€æˆ–â€œä¸‹è½½æ¨¡æ¿â€æŸ¥çœ‹æ ¼å¼</p>
    </div>
</div>

<!-- æ¨¡æ€æ¡† -->
<div id="customModal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 id="modalTitle">æç¤º</h3>
        <div id="modalMessage" style="color: #666; font-size: 14px; line-height: 1.6;">å†…å®¹</div>
        <div class="modal-actions">
            <button class="btn" style="background:#f1f3f5; color:#555;" id="modalCancelBtn" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="modalConfirmBtn">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        getRangeClass: (score) => {
            const s = Number(score);
            if (s >= 90) return "bg-90";
            if (s >= 80) return "bg-80";
            if (s >= 60) return "bg-60";
            if (s >= 50) return "bg-50";
            return "bg-low";
        },
        scoreKeywords: ["åˆ†æ•°", "æˆç»©", "score", "æ€»åˆ†"],
        classKeywords: ["ç­å‹", "ç­çº§", "class", "type"],
        chartColors: ['#FEC200', '#FF9F40', '#FFCE56', '#4BC0C0', '#36A2EB', '#9966FF', '#00B050']
    };

    let examGroups = {}; 
    let examNames = [];
    let currentExamName = "";
    let currentClassIdx = 0;
    
    let chartInstance = null;
    let currentExc = 85;
    let currentPass = 60;
    let isHiddenMode = false;

    // --- æ¨¡æ¿ä¸‹è½½ ---
    function downloadTemplate() {
        const wb = XLSX.utils.book_new();
        
        // ç¤ºä¾‹ 1: å•åœºè€ƒè¯•åˆ†ç­
        const data1 = [
            ["å¹´åº¦", "å­¦æœŸ", "å¹´çº§", "ç­å‹", "æµ‹è¯•ç±»å‹", "åˆ†æ•°"],
            ["2025", "æ˜¥å­£", "3å¹´çº§", "A3ç­", "æœŸä¸­", 98],
            ["2025", "æ˜¥å­£", "3å¹´çº§", "A3ç­", "æœŸä¸­", 85],
            ["2025", "æ˜¥å­£", "3å¹´çº§", "A7ç­", "æœŸä¸­", 76],
            ["2025", "æ˜¥å­£", "3å¹´çº§", "A7ç­", "æœŸä¸­", 92],
            ["2025", "æ˜¥å­£", "3å¹´çº§", "A3ç­", "æœŸä¸­", 60]
        ];
        const ws1 = XLSX.utils.aoa_to_sheet(data1);
        XLSX.utils.book_append_sheet(wb, ws1, "æ ‡å‡†æ¨¡æ¿");

        // ç¤ºä¾‹ 2: å¤šåœºè€ƒè¯•æ‰¹é‡
        const data2 = [
            ["", "", "", "", "", "ç¬¬1åœº", "", "", "", "", "", "ç¬¬2åœº"],
            ["å¹´åº¦", "å­¦æœŸ", "å¹´çº§", "ç­å‹", "æµ‹è¯•", "åˆ†æ•°", "", "å¹´åº¦", "å­¦æœŸ", "å¹´çº§", "ç­å‹", "æµ‹è¯•", "åˆ†æ•°"],
            ["2025", "æ˜¥å­£", "3å¹´çº§", "A3", "ä¸€æµ‹", 90, "", "2025", "æ˜¥å­£", "3å¹´çº§", "A3", "äºŒæµ‹", 88],
            ["2025", "æ˜¥å­£", "3å¹´çº§", "A3", "ä¸€æµ‹", 85, "", "2025", "æ˜¥å­£", "3å¹´çº§", "A3", "äºŒæµ‹", 92],
            ["2025", "æ˜¥å­£", "3å¹´çº§", "A7", "ä¸€æµ‹", 70, "", "2025", "æ˜¥å­£", "3å¹´çº§", "A7", "äºŒæµ‹", 75],
        ];
        const ws2 = XLSX.utils.aoa_to_sheet(data2);
        XLSX.utils.book_append_sheet(wb, ws2, "å¤šåœºè€ƒè¯•æ¨¡æ¿");

        XLSX.writeFile(wb, "æˆç»©åˆ†æ_æ ‡å‡†æ¨¡æ¿.xlsx");
    }

    // --- ä½¿ç”¨è¯´æ˜ ---
    function showGuide() {
        const msg = `
            <div style="font-size:13px;">
                <p><strong>ğŸ“Š æ•°æ®æ ¼å¼è§„èŒƒï¼š</strong></p>
                <p>1. ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰«æç¬¬6è¡Œï¼ˆæˆ–å…¶ä»–å«â€œåˆ†æ•°â€å­—æ ·çš„è¡Œï¼‰ä½œä¸ºè¡¨å¤´ã€‚</p>
                <p>2. å¿…é¡»åŒ…å« <strong>â€œåˆ†æ•°â€</strong> åˆ—ã€‚</p>
                <p>3. è‹¥è¦è‡ªåŠ¨åˆ†ç­åˆ†æï¼Œè¯·åœ¨â€œåˆ†æ•°â€åˆ—å·¦ä¾§æ·»åŠ  <strong>â€œç­å‹â€</strong> åˆ—ã€‚</p>
                
                <p style="margin-top:10px;"><strong>ğŸ“‚ Excel ç»“æ„ç¤ºä¾‹ï¼š</strong></p>
                <table class="guide-table">
                    <tr><th>A</th><th>B</th><th>C</th><th>D (ç­å‹)</th><th class="highlight-col">E (åˆ†æ•°)</th></tr>
                    <tr><td>2025</td><td>æ˜¥å­£</td><td>3å¹´çº§</td><td>A3ç­</td><td class="highlight-col">98</td></tr>
                    <tr><td>2025</td><td>æ˜¥å­£</td><td>3å¹´çº§</td><td>A7ç­</td><td class="highlight-col">85</td></tr>
                </table>
                <p style="font-size:12px; color:#999; margin-top:5px;">* æ”¯æŒå¤šåˆ—å¹¶æ’ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¤šåœºè€ƒè¯•ã€‚</p>
            </div>
        `;
        showModal("æ–°æ‰‹ä½¿ç”¨æŒ‡å—", "", "info", null);
        document.getElementById('modalMessage').innerHTML = msg;
    }

    // --- è§£ææ ¸å¿ƒ ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
                
                parseBatchExams(json);
                
                if (examNames.length === 0) throw "æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®";
                
                initNav();
                
                document.getElementById('thresholdPanel').classList.remove('hidden');
                document.getElementById('actionPanel').classList.remove('hidden');
                document.getElementById('navContainer').classList.remove('hidden');
                document.getElementById('result-container').classList.remove('hidden');
                document.getElementById('emptyState').classList.add('hidden');
            } catch (err) { showModal("è¯»å–å¤±è´¥", err); }
        };
        reader.readAsArrayBuffer(file);
    });

    function parseBatchExams(json) {
        examGroups = {};
        examNames = [];
        const headerRowIndex = 5; 
        const headerRow = json[headerRowIndex];
        if (!headerRow) return;

        for (let col = 0; col < headerRow.length; col++) {
            const cellVal = String(headerRow[col] || "").toLowerCase().trim();
            if (CONFIG.scoreKeywords.some(k => cellVal.includes(k))) {
                
                let classTypeCol = -1;
                if (col > 0) {
                    const leftHeader = String(headerRow[col-1] || "").toLowerCase().trim();
                    if (CONFIG.classKeywords.some(k => leftHeader.includes(k))) {
                        classTypeCol = col - 1;
                    }
                }

                let baseTitle = "";
                for(let r=0; r<5; r++) {
                    if (json[r] && json[r][col]) baseTitle += String(json[r][col]) + " ";
                }
                baseTitle = baseTitle.replace(/åˆ†æ•°|æ ¹æ®ç­å‹è‡ªåŠ¨å¡«å……|æµ‹è¯•ç±»å‹/g, "").replace(/\s+/g, " ").trim();
                if(!baseTitle) baseTitle = `è€ƒè¯• ${examNames.length + 1}`;

                const rowsData = [];
                for(let r = headerRowIndex + 1; r < json.length; r++) {
                    const row = json[r];
                    if (row) {
                        const val = row[col];
                        if (val !== undefined && val !== null && val !== "" && !isNaN(val)) {
                            const cls = classTypeCol > -1 ? String(row[classTypeCol] || "æœªåˆ†ç±»") : "é»˜è®¤";
                            rowsData.push({ score: Number(val), classType: cls });
                        }
                    }
                }

                if (rowsData.length > 0) {
                    const groups = {};
                    rowsData.forEach(d => {
                        if (d.classType && d.classType !== "undefined" && !d.classType.includes("è‡ªåŠ¨å¡«å……")) {
                            if(!groups[d.classType]) groups[d.classType] = [];
                            groups[d.classType].push(d.score);
                        }
                    });

                    const classList = Object.keys(groups).sort().map(name => ({
                        name: name,
                        scores: groups[name].sort((a,b)=>b-a)
                    }));

                    if (classList.length > 0) {
                        examGroups[baseTitle] = classList;
                        examNames.push(baseTitle);
                    }
                }
            }
        }
    }

    // --- å¯¼èˆªé€»è¾‘ ---
    function initNav() {
        const l1Container = document.getElementById('level1Tabs');
        l1Container.innerHTML = "";
        
        let commonPrefix = "";
        if (examNames.length > 1) {
            const s1 = examNames[0], s2 = examNames[examNames.length-1];
            let i = 0;
            while(i < s1.length && s1.charAt(i) === s2.charAt(i)) i++;
            commonPrefix = s1.substring(0, i);
        }

        examNames.forEach((name, idx) => {
            const btn = document.createElement('button');
            btn.className = `tab-l1 ${idx===0 ? 'active' : ''}`;
            
            let label = name;
            if (commonPrefix.length > 4 && label.startsWith(commonPrefix)) {
                const suffix = label.substring(commonPrefix.length).trim();
                if (suffix.length > 0) label = suffix;
            }
            
            btn.innerHTML = `<i class="ph ph-folder-notch"></i> ${label}`;
            btn.title = name;
            btn.onclick = () => switchExam(name);
            l1Container.appendChild(btn);
        });

        switchExam(examNames[0]);
    }

    function switchExam(name) {
        currentExamName = name;
        
        const l1Btns = document.querySelectorAll('.tab-l1');
        l1Btns.forEach(btn => {
            if(btn.title === name) btn.classList.add('active');
            else btn.classList.remove('active');
        });

        const l2Container = document.getElementById('level2Tabs');
        const l2Wrapper = document.getElementById('level2Container');
        l2Container.innerHTML = "";
        
        const classes = examGroups[name];
        if (classes && classes.length > 0) {
            l2Wrapper.classList.remove('hidden');
            classes.forEach((cls, idx) => {
                const btn = document.createElement('button');
                btn.className = `tab-l2 ${idx===0 ? 'active' : ''}`;
                btn.innerHTML = cls.name === "é»˜è®¤" ? "æˆç»©æŠ¥è¡¨" : cls.name;
                btn.onclick = () => switchClass(idx);
                l2Container.appendChild(btn);
            });
            switchClass(0);
        } else {
            l2Wrapper.classList.add('hidden');
        }
    }

    function switchClass(idx) {
        currentClassIdx = idx;
        const l2Btns = document.querySelectorAll('.tab-l2');
        l2Btns.forEach((btn, i) => {
            if(i === idx) btn.classList.add('active');
            else btn.classList.remove('active');
        });
        refreshDisplay();
    }

    function applySettings() {
        currentExc = Number(document.getElementById('excThreshold').value);
        currentPass = Number(document.getElementById('passThreshold').value);
        refreshDisplay();
    }

    function refreshDisplay() {
        const clsData = examGroups[currentExamName][currentClassIdx];
        renderTable(clsData, isHiddenMode);
        renderChart(clsData);
    }

    function switchViewMode(hidden) {
        isHiddenMode = hidden;
        refreshDisplay();
    }

    // --- æ¸²æŸ“é€»è¾‘ ---
    function renderTable(clsData, hidden) {
        const scores = clsData.scores;
        const n = scores.length;
        const sum = scores.reduce((a,b)=>a+b,0);
        const avg = (sum/n).toFixed(1);
        const max = scores[0], min = scores[n-1];
        const midIdx = Math.floor(n/2);
        const median = n%2!==0 ? scores[midIdx] : ((scores[midIdx-1]+scores[midIdx])/2).toFixed(1);
        const stdDev = Math.sqrt(scores.map(x=>Math.pow(x-avg,2)).reduce((a,b)=>a+b)/n).toFixed(1);
        const excRate = ((scores.filter(s=>s>=currentExc).length/n)*100).toFixed(1)+"%";
        const passRate = ((scores.filter(s=>s>=currentPass).length/n)*100).toFixed(1)+"%";

        const counts = {};
        scores.forEach(s => counts[Math.floor(s)] = (counts[Math.floor(s)]||0)+1);
        
        const dataArr = [];
        let cum = 0;
        for(let s=100; s>=0; s--) {
            if(counts[s]>0 || s===100 || s===0) {
                cum += (counts[s]||0);
                dataArr.push({ s, c:counts[s]||0, cum, pct:((cum/n)*100).toFixed(1)+"%" });
            }
        }

        const totalCols = 15; 
        const rowsCount = Math.ceil(dataArr.length / 3);
        
        let html = `<table class="main-table">`;
        const titleText = hidden ? `${currentExamName} (${clsData.name})` : `${currentExamName} (${clsData.name === "é»˜è®¤" ? "" : clsData.name}) æ€»äººæ•°: ${n}äºº`;
        html += `<tr class="row-title"><th colspan="${totalCols}">${titleText}</th></tr>`;

        // ç»Ÿè®¡è¡Œ
        html += `
            <tr>
                <td colspan="5" class="${CONFIG.getRangeClass(max)}">æœ€é«˜åˆ†: ${max}</td>
                <td colspan="5" class="${CONFIG.getRangeClass(min)}">æœ€ä½åˆ†: ${min}</td>
                <td colspan="5" class="${CONFIG.getRangeClass(avg)}">å¹³å‡åˆ†: ${avg}</td>
            </tr>
            <tr>
                <td colspan="7" class="${CONFIG.getRangeClass(median)}">ä¸­ä½çº¿: ${median}</td>
                <td colspan="8" class="cell-static-green">æ ‡å‡†å·®: ${stdDev}</td>
            </tr>
            <tr>
                <td colspan="7" class="${CONFIG.getRangeClass(currentExc)}">ä¼˜ç§€ç‡ (â‰¥${currentExc}): ${excRate}</td>
                <td colspan="8" class="${CONFIG.getRangeClass(currentPass)}">åŠæ ¼ç‡ (â‰¥${currentPass}): ${passRate}</td>
            </tr>
            <tr class="row-col-header">
        `;
        
        for(let i=0; i<3; i++) html += hidden ? `<td colspan="2">åˆ†æ•°</td><td colspan="3">æ’å%</td>` : `<td>åˆ†æ•°</td><td>äººæ•°</td><td>ç´¯è®¡</td><td>åæ¬¡</td><td>æ’å%</td>`;
        html += `</tr>`;

        for(let i=0; i<rowsCount; i++) {
            html += `<tr>`;
            for(let j=0; j<3; j++) {
                const item = dataArr[i + j*rowsCount];
                if(item) {
                    const cls = CONFIG.getRangeClass(item.s);
                    if(hidden) {
                        html += `<td colspan="2" class="${cls}">${item.s}</td><td colspan="3" class="${cls}">${item.pct}</td>`;
                    } else {
                        html += `<td class="${cls}">${item.s}</td><td class="${cls}">${item.c}</td><td class="${cls}">${item.cum}</td><td class="${cls}">${item.cum}</td><td class="${cls}">${item.pct}</td>`;
                    }
                } else { html += `<td colspan="5"></td>`; }
            }
            html += `</tr>`;
        }
        document.getElementById('table-capture-area').innerHTML = html + `</table>`;
    }

    function renderChart(clsData) {
        const scores = clsData.scores;
        const bins = ["0-59", "60-69", "70-79", "80-84", "85-89", "90-95", "96-100"];
        const data = [0,0,0,0,0,0,0];
        scores.forEach(s => {
            if(s<60) data[0]++; else if(s<70) data[1]++; else if(s<80) data[2]++;
            else if(s<85) data[3]++; else if(s<90) data[4]++; else if(s<96) data[5]++; else data[6]++;
        });

        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('scoreChart'), {
            type: 'bar', plugins: [ChartDataLabels],
            data: { labels: bins, datasets: [{ data, backgroundColor: CONFIG.chartColors }] },
            options: {
                responsive: true,
                plugins: { legend: { display: false }, datalabels: { anchor:'end', align:'top', formatter:(v)=>(v/scores.length*100).toFixed(1)+'%', font:{weight:'bold'} } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // --- å¯¼å‡ºé€»è¾‘ ---
    function renderAndExport(forceHidden) {
        const originalMode = isHiddenMode;
        if (typeof forceHidden !== 'undefined') {
            const clsData = examGroups[currentExamName][currentClassIdx];
            renderTable(clsData, forceHidden);
        }

        setTimeout(() => {
            const area = document.getElementById('table-capture-area');
            if (!area) return;
            html2canvas(area, {scale: 2, backgroundColor:"#fff"}).then(canvas => {
                const link = document.createElement('a');
                const clsData = examGroups[currentExamName][currentClassIdx];
                const suffix = (typeof forceHidden !== 'undefined' ? forceHidden : isHiddenMode) ? 'éšè—ç‰ˆ' : 'å®Œæ•´ç‰ˆ';
                link.download = `${currentExamName}_${clsData.name}_${suffix}.png`;
                link.href = canvas.toDataURL(); link.click();
                
                if (typeof forceHidden !== 'undefined') {
                    const clsData = examGroups[currentExamName][currentClassIdx];
                    renderTable(clsData, originalMode);
                }
            });
        }, 100);
    }

    function exportToExcel() {
        const clsData = examGroups[currentExamName][currentClassIdx];
        const scores = clsData.scores;
        const wb = XLSX.utils.book_new();
        const wsData = [["åˆ†æ•°", "äººæ•°", "ç´¯è®¡", "æ’å%"]];
        
        const counts = {}; scores.forEach(s=>counts[Math.floor(s)]=(counts[Math.floor(s)]||0)+1);
        let cum = 0;
        for(let s=100; s>=0; s--) {
            cum += (counts[s]||0);
            wsData.push([s, counts[s]||0, cum, ((cum/scores.length)*100).toFixed(1)+"%"]);
        }
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "ä¸€åˆ†ä¸€æ®µè¡¨");
        XLSX.writeFile(wb, `${currentExamName}_${clsData.name}.xlsx`);
    }

    function exportChartImg() {
        const area = document.getElementById('chartCard');
        if (!area) return;
        html2canvas(area, {scale: 2}).then(canvas => {
            const link = document.createElement('a');
            link.download = `ç»Ÿè®¡å›¾.png`;
            link.href = canvas.toDataURL(); link.click();
        });
    }

    // é€šç”¨
    function confirmClearData() {
        showModal("ç¡®è®¤æ“ä½œ", "ç¡®å®šæ¸…ç©ºæ•°æ®ï¼Ÿ", "confirm", () => { location.reload(); });
    }
    function showModal(t, m, type, cb) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').innerText = t;
        // æ”¯æŒ HTML å†…å®¹æ˜¾ç¤º
        document.getElementById('modalMessage').innerHTML = m;
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');
        
        const newConfirm = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
        
        if (type === 'confirm') {
            cancelBtn.classList.remove('hidden');
            newConfirm.onclick = () => { if(cb) cb(); closeModal(); };
        } else {
            cancelBtn.classList.add('hidden');
            newConfirm.onclick = closeModal;
        }
        modal.classList.remove('hidden');
    }
    function closeModal() { document.getElementById('customModal').classList.add('hidden'); }
</script>
</body>
</html>